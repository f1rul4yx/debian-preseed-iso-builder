#_preseed_V1
#### Configuración automatizada Debian 13 Trixie - ASIR
#### Proyecto: Instalación desatendida con LVM y GNOME

### Localization - Configuración regional
d-i debian-installer/locale string es_ES.UTF-8
d-i debian-installer/language string es
d-i debian-installer/country string ES

# Configuración de teclado español
d-i keyboard-configuration/xkb-keymap select es
d-i keyboard-configuration/toggle select No toggling

### Network configuration - Configuración de red
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string debian
d-i netcfg/get_domain string local
d-i netcfg/wireless_wep string

### Mirror settings - Configuración de repositorios
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string

### Account setup - Configuración de cuentas
# Contraseña de root cifrada con mkpasswd -m sha-512
# Contraseña actual: "root" (CAMBIAR EN PRODUCCIÓN)
d-i passwd/root-password-crypted password $6$pKTLCKwzHUpl0kvA$NHfvORhpCVwZfMKyQw0orEaD3HLFV9tds37lfkdgLdmE2KVXzpoqNLXyCOPjVuyqY4HRsjBNbkx0DWdiyGukQ.

# Usuario normal
d-i passwd/user-fullname string Usuario Debian
d-i passwd/username string debian
# Contraseña: "debian" (CAMBIAR EN PRODUCCIÓN)
d-i passwd/user-password-crypted password $6$0jipih8/tqP0KtEv$0m.Vs.W14zj5a8R.YXaQNCPMXR/S5NKEZfDcYTbGmJoA4vyvVWN.jmZrvMQz2EekQUEQLI6hhltp/VAMXYevz0

# Grupos del usuario
d-i passwd/user-default-groups string audio cdrom video sudo

### Clock and time zone setup - Zona horaria
d-i clock-setup/utc boolean true
d-i time/zone string Europe/Madrid
d-i clock-setup/ntp boolean true

### Partitioning - Configuración de particiones con LVM
# Método: LVM
d-i partman-auto/method string lvm

# Usar todo el espacio disponible para LVM
d-i partman-auto-lvm/guided_size string max

# Confirmar eliminación de configuraciones previas
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# Forzar GPT para compatibilidad UEFI
d-i partman-partitioning/choose_label select gpt
d-i partman-partitioning/default_label string gpt

# Receta de particionado personalizada OPTIMIZADA PARA DISCOS PEQUEÑOS
# Compatible con discos desde 15-20 GB hasta discos grandes
#
# VALORES FIJOS: EFI (538 MB) y /boot (350 MB reducido)
# RESTO: Usa prioridades para distribución proporcional
#
# Formato: mínimo prioridad máximo
# - mínimo: tamaño mínimo garantizado (MB)
# - prioridad: peso relativo para distribuir espacio
# - máximo: límite superior (MB o valor grande)
#
# DISTRIBUCIÓN PARA DIFERENTES TAMAÑOS:
# 
# Disco 20 GB (espacio LVM ~18.5 GB):
# - swap: 1 GB (5%)
# - root: 9 GB (50%)
# - var: 3 GB (15%)
# - home: 5.5 GB (30%)
#
# Disco 50 GB (espacio LVM ~48.5 GB):
# - swap: 2 GB (4%)
# - root: 20 GB (42%)
# - var: 10 GB (21%)
# - home: 16.5 GB (33%)
#
# Disco 100 GB+ (espacio LVM ~98.5 GB):
# - swap: 4 GB (límite máximo)
# - root: 35 GB (límite máximo) 
# - var: 20 GB (límite máximo)
# - home: resto disponible

d-i partman-auto/expert_recipe string                         \
      asir-lvm ::                                             \
              538 538 538 free                                \
                      $iflabel{ gpt }                         \
                      $reusemethod{ }                         \
                      method{ efi } format{ }                 \
              .                                               \
              350 350 350 ext4                                \
                      $primary{ } $bootable{ }                \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /boot }                     \
              .                                               \
              512 1024 4096 linux-swap                        \
                      $lvmok{ }                               \
                      lv_name{ swap }                         \
                      in_vg{ vg0 }                            \
                      method{ swap } format{ }                \
              .                                               \
              5120 10240 35840 ext4                           \
                      $lvmok{ }                               \
                      lv_name{ root }                         \
                      in_vg{ vg0 }                            \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ / }                         \
              .                                               \
              2048 3072 20480 ext4                            \
                      $lvmok{ }                               \
                      lv_name{ var }                          \
                      in_vg{ vg0 }                            \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /var }                      \
              .                                               \
              2048 6144 1000000000 ext4                       \
                      $lvmok{ }                               \
                      lv_name{ home }                         \
                      in_vg{ vg0 }                            \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /home }                     \
              .

# Confirmaciones automáticas (instalación desatendida)
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# Asegurar soporte EFI
d-i partman-efi/non_efi_system boolean true

### Base system installation
d-i base-installer/install-recommends boolean true

### Apt setup - Configuración de repositorios
d-i apt-setup/cdrom/set-first boolean false
d-i apt-setup/non-free-firmware boolean true
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true
d-i apt-setup/disable-cdrom-entries boolean true
d-i apt-setup/services-select multiselect security, updates
d-i apt-setup/security_host string security.debian.org

### Package selection - Selección de paquetes
# Instalar entorno GNOME
tasksel tasksel/first multiselect standard, gnome-desktop

# Paquetes adicionales requeridos por la actividad
d-i pkgsel/include string openssh-server firewalld network-manager-gnome

# Actualización completa después de instalación
d-i pkgsel/upgrade select full-upgrade

# Desactivar popularity contest
popularity-contest popularity-contest/participate boolean false

### Boot loader installation - Instalación de GRUB
# Instalar GRUB automáticamente
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true

# Instalar en el dispositivo principal (compatible BIOS/UEFI)
d-i grub-installer/bootdev string default

### Finishing up - Finalización
# Reiniciar automáticamente al finalizar
d-i finish-install/reboot_in_progress note

# No expulsar el medio de instalación
d-i cdrom-detect/eject boolean false

### Comandos post-instalación
# Habilitar y configurar servicios requeridos
d-i preseed/late_command string \
    in-target systemctl enable ssh; \
    in-target systemctl enable firewalld; \
    in-target firewall-cmd --permanent --add-service=ssh; \
    in-target firewall-cmd --reload; \
    in-target sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
